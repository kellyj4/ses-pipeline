AWSTemplateFormatVersion: "2010-09-09"
Description: "Automated SES domain verification and DKIM setup for a specified domain in ap-southeast-2."

Parameters:
  DomainName:
    Type: String
    Description: "The domain name to verify with SES (e.g., subdomain.domain.gov.au)."
  MailFromDomainName:
    Type: String
    Description: "This needs to be a subdomain of !Ref DomainName"
  ExistingVPCID:
    Type: String
    Description: "The ID of an existing VPC where SES resources can be created" 
  ExistingVPCSubnetIDs:
    Type: CommaDelimitedList
    Description: "A list of existing Subnet IDs within the VPC."

Resources:
  # Create the SES Domain Identity
  # This resource verifies domain ownership and automatically generates the DKIM tokens.
  SESVPCEndpointServiceAPIEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref ExistingVPCID
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.email"
      VpcEndpointType: Interface
      SubnetIds: !Ref ExistingVPCSubnetIDs
      
  SESVPCEndpointMailManagerIngressEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref ExistingVPCID
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.mail-manager-smtp.auth"
      VpcEndpointType: Interface
      SubnetIds: !Ref ExistingVPCSubnetIDs

  SESVPCEndpointEmailSMTPOutbound:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref ExistingVPCID
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.email-smtp"
      VpcEndpointType: Interface
      SubnetIds: !Ref ExistingVPCSubnetIDs

#  SESVPCEndpointEmailCustomMailFromFeedback:
#    Type: AWS::EC2::VPCEndpoint
#    Properties:
#      VpcId: !Ref ExistingVPCID
#      ServiceName: !Sub "com.amazonses.${AWS::Region}.feedback-smtp"
#      VpcEndpointType: Interface
#      SubnetIds: !Ref ExistingVPCSubnetIDs
        
  SESDomainIdentity:
    Type: AWS::SES::EmailIdentity
    Properties:
      ConfigurationSetAttributes: 
        ConfigurationSetName: !Ref SESMailConfigurationSet
      EmailIdentity: !Ref DomainName
      DkimSigningAttributes:
        NextSigningKeyLength: "RSA_2048_BIT"
      MailFromAttributes:
        MailFromDomain: !Ref MailFromDomainName
      Tags:
        - Key: "environment"
          Value: "poc"
        - Key: "deployment"
          Value: "manual"

  SESMailManagerTrafficPolicy:
    Type: AWS::SES::MailManagerTrafficPolicy
    Properties:
      TrafficPolicyName: DENY-Policy
      DefaultAction: DENY
      PolicyStatements:
        - Action: DENY
          Conditions:
            - IpExpression:
                Evaluate:
                  Attribute:
                    SENDER_IP
                Operator: NOT_CIDR_MATCHES
                Values:
                  - "127.0.0.1/32"

  SESMailManagerRuleSet:
    Type: AWS::SES::MailManagerRuleSet
    Properties:
      RuleSetName: RuleSetNumber1
      Rules:
        - Actions:
            - Archive:
                ActionFailurePolicy: CONTINUE
                TargetArchive: !GetAtt SESMailManagerArchive.ArchiveId

  SESMailManagerArchive:
    Type: AWS::SES::MailManagerArchive
    Properties:
      ArchiveName: !Join ['-', ['sentEmail', !Select [4, !Split ['-', !Select [2, !Split ['/', !Ref AWS::StackId]]]]]]
      Retention:
         RetentionPeriod: "THREE_MONTHS"

  SESMailManagerIngressPoint:
    Type: AWS::SES::MailManagerIngressPoint
    Properties:
      IngressPointName: IngressPoint1
      RuleSetId: !GetAtt SESMailManagerRuleSet.RuleSetId
      StatusToUpdate: CLOSED
      Tags:
        - Key: "environment"
          Value: "poc"
        - Key: "deployment"
          Value: "manual"
      TrafficPolicyId: !GetAtt SESMailManagerTrafficPolicy.Id
      Type: AUTH

  SESMailConfigurationSet:
    Type: AWS::SES::ConfigurationSet
    Properties:
       Name: ConfigSet1

  SESMailReceiptRuleSet:
     Type: AWS::SES::ReceiptRuleSet
     Properties:
       RuleSetName: default-rule-set


#  # DNS CNAME records for DKIM
#  # This resource creates three CNAME records using the DKIM tokens.
#  SESDKIMRecords:
#    Type: AWS::Route53::RecordSetGroup
#    Properties:
#      HostedZoneId: !Ref Route53ZoneId
#      RecordSets:
#        - Name: !GetAtt SESDomainIdentity.DkimDNSTokenName1
#          Type: CNAME
#          TTL: "60"
#          ResourceRecords:
#            - !GetAtt SESDomainIdentity.DkimDNSTokenValue1
#        - Name: !GetAtt SESDomainIdentity.DkimDNSTokenName2
#          Type: CNAME
#          TTL: "60"
#          ResourceRecords:
#            - !GetAtt SESDomainIdentity.DkimDNSTokenValue2
#        - Name: !GetAtt SESDomainIdentity.DkimDNSTokenName3
#          Type: CNAME
#          TTL: "60"
#          ResourceRecords:
#            - !GetAtt SESDomainIdentity.DkimDNSTokenValue3
#        - Name: !Sub "_dmarc.${DomainName}"
#          Type: TXT
#          TTL: "60"
#          ResourceRecords:
#             - '"v=DMARC1; p=none;"'
#        - Name: !Sub "${MailFromDomainName}"
#          Type: TXT
#          TTL: "60"
#          ResourceRecords:
#             - '"v=spf1 include:amazonses.com ~all"'
#        - Name: !Sub "${MailFromDomainName}"
#          Type: MX
#          TTL: "60"
#          ResourceRecords:
#             - "10 feedback-smtp.ap-southeast-2.amazonses.com"
