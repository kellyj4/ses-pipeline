AWSTemplateFormatVersion: "2010-09-09"
Description: "Automated SES domain verification and DKIM setup for a specified domain in ap-southeast-2."

Parameters:
  DomainName:
    Type: String
    Description: "The domain name to verify with SES (e.g., subdomain.domain.gov.au)."
  MailFromDomainName:
    Type: String
    Description: "This needs to be a subdomain of !Ref DomainName"
  ExistingVPCID:
    Type: String
    Description: "The ID of an existing VPC where SES resources can be created" 
  ExistingVPCSubnetIDs:
    Type: CommaDelimitedList
    Description: "A list of existing Subnet IDs within the VPC."
  ExistingSNSTopicARN:
    Type: String
    Description: "The ARN of an existing SNS Topic for SES Notifications."

Resources:
  # Create the SES Domain Identity
  # This resource verifies domain ownership and automatically generates the DKIM tokens.
  SESVPCEndpointServiceAPIEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref ExistingVPCID
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.email"
      VpcEndpointType: Interface
      SubnetIds: !Ref ExistingVPCSubnetIDs
      
  SESVPCEndpointMailManagerIngressEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref ExistingVPCID
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.mail-manager-smtp.auth"
      VpcEndpointType: Interface
      SubnetIds: !Ref ExistingVPCSubnetIDs

  SESVPCEndpointEmailSMTPOutbound:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref ExistingVPCID
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.email-smtp"
      VpcEndpointType: Interface
      SubnetIds: !Ref ExistingVPCSubnetIDs

  SESDomainIdentity:
    Type: AWS::SES::EmailIdentity
    Properties:
      ConfigurationSetAttributes: 
        ConfigurationSetName: !Ref SESMailConfigurationSet
      EmailIdentity: !Ref DomainName
      DkimSigningAttributes:
        NextSigningKeyLength: "RSA_2048_BIT"
      MailFromAttributes:
        MailFromDomain: !Ref MailFromDomainName
      Tags:
        - Key: "environment"
          Value: "poc"
        - Key: "deployment"
          Value: "manual"

  SESMailManagerTrafficPolicy:
    Type: AWS::SES::MailManagerTrafficPolicy
    Properties:
      TrafficPolicyName: DENY-Policy
      DefaultAction: DENY
      PolicyStatements:
        - Action: DENY
          Conditions:
            - IpExpression:
                Evaluate:
                  Attribute:
                    SENDER_IP
                Operator: NOT_CIDR_MATCHES
                Values:
                  - "127.0.0.1/32"

  SESMailManagerRuleSet:
    Type: AWS::SES::MailManagerRuleSet
    Properties:
      RuleSetName: RuleSetNumber1
      Rules:
        - Actions:
            - Archive:
                ActionFailurePolicy: CONTINUE
                TargetArchive: !GetAtt SESMailManagerArchive.ArchiveId

  SESMailManagerArchive:
    Type: AWS::SES::MailManagerArchive
    Properties:
      ArchiveName: !Join ['-', ['sentEmail', !Select [4, !Split ['-', !Select [2, !Split ['/', !Ref AWS::StackId]]]]]]
      Retention:
         RetentionPeriod: "THREE_MONTHS"

  SESMailManagerIngressPoint:
    Type: AWS::SES::MailManagerIngressPoint
    Properties:
      IngressPointConfiguration:
        SmtpPassword: "Qwerty1234567890!!!"
      IngressPointName: IngressPoint1
      NetworkConfiguration:
        PrivateNetworkConfiguration:
          VpcEndpointId: !GetAtt SESVPCEndpointMailManagerIngressEndpoint.Id
      RuleSetId: !GetAtt SESMailManagerRuleSet.RuleSetId
      Tags:
        - Key: "environment"
          Value: "poc"
        - Key: "deployment"
          Value: "manual"
      TrafficPolicyId: !GetAtt SESMailManagerTrafficPolicy.TrafficPolicyId
      Type: AUTH

  SESMailConfigurationSet:
    Type: AWS::SES::ConfigurationSet
    Properties:
       Name: ConfigSet1
       DeliveryOptions:
         TlsPolicy: REQUIRE

  SESConfigurationSetEventDestination:
    Type: AWS::SES::ConfigurationSetEventDestination
    Properties:
      ConfigurationSetName: !GetAtt SESMailConfigurationSet.Name
      EventDestination:
         Name: SNSDestination
         Enabled: true
         MatchingEventTypes:
           - SEND
           - REJECT
           - BOUNCE
           - COMPLAINT
           - DELIVERY
           - OPEN
           - CLICK
           - RENDERING_FAILURE
         SnsDestination:
           TopicARN: !Ref ExistingSNSTopicARN

  SESMailReceiptRuleSet:
     Type: AWS::SES::ReceiptRuleSet
     Properties:
       RuleSetName: default-rule-set
