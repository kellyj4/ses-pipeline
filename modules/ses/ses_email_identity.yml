AWSTemplateFormatVersion: "2010-09-09"
Description: "Automated SES domain verification and DKIM setup for a specified domain in ap-southeast-2."

Parameters:
  DomainName:
    Type: String
    Description: "The domain name to verify with SES (e.g., subdomain.domain.gov.au)."
  MailFromDomainName:
    Type: String
    Description: "This needs to be a subdomain of !Ref DomainName"
  ExistingVPCID:
    Type: String
    Description: "The ID of an existing VPC where SES resources can be created" 
  ExistingVPCSubnetIDs:
    Type: CommaDelimitedList
    Description: "A list of existing Subnet IDs within the VPC."

Resources:
  # Create the SES Domain Identity
  # This resource verifies domain ownership and automatically generates the DKIM tokens.
  SESVPCEndpointServiceAPIEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref ExistingVPCID
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.email"
      VpcEndpointType: Interface
      SubnetIds: !Ref ExistingVPCSubnetIDs
      
  SESVPCEndpointMailManagerIngressEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref ExistingVPCID
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.mail-manager-smtp.auth"
      VpcEndpointType: Interface
      SubnetIds: !Ref ExistingVPCSubnetIDs

  SESVPCEndpointEmailSMTPOutbound:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref ExistingVPCID
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.email-smtp"
      VpcEndpointType: Interface
      SubnetIds: !Ref ExistingVPCSubnetIDs

  SESDomainIdentity:
    Type: AWS::SES::EmailIdentity
    Properties:
      ConfigurationSetAttributes: 
        ConfigurationSetName: !Ref SESMailConfigurationSet
      EmailIdentity: !Ref DomainName
      DkimSigningAttributes:
        NextSigningKeyLength: "RSA_2048_BIT"
      MailFromAttributes:
        MailFromDomain: !Ref MailFromDomainName
      Tags:
        - Key: "environment"
          Value: "poc"
        - Key: "deployment"
          Value: "manual"

  SESMailManagerTrafficPolicy:
    Type: AWS::SES::MailManagerTrafficPolicy
    Properties:
      TrafficPolicyName: DENY-Policy
      DefaultAction: DENY
      PolicyStatements:
        - Action: DENY
          Conditions:
            - IpExpression:
                Evaluate:
                  Attribute:
                    SENDER_IP
                Operator: NOT_CIDR_MATCHES
                Values:
                  - "127.0.0.1/32"

  SESMailManagerRuleSet:
    Type: AWS::SES::MailManagerRuleSet
    Properties:
      RuleSetName: RuleSetNumber1
      Rules:
        - Actions:
            - Archive:
                ActionFailurePolicy: CONTINUE
                TargetArchive: !GetAtt SESMailManagerArchive.ArchiveId

  SESMailManagerArchive:
    Type: AWS::SES::MailManagerArchive
    Properties:
      ArchiveName: !Join ['-', ['sentEmail', !Select [4, !Split ['-', !Select [2, !Split ['/', !Ref AWS::StackId]]]]]]
      Retention:
         RetentionPeriod: "THREE_MONTHS"

  SESMailManagerIngressPoint:
    Type: AWS::SES::MailManagerIngressPoint
    Properties:
      IngressPointConfiguration:
        SmtpPassword: "Qwerty1234567890!!!"
      IngressPointName: IngressPoint1
      NetworkConfiguration:
        PrivateNetworkConfiguration:
          VpcEndpointId: !GetAtt SESVPCEndpointMailManagerIngressEndpoint.Id
      RuleSetId: !GetAtt SESMailManagerRuleSet.RuleSetId
      Tags:
        - Key: "environment"
          Value: "poc"
        - Key: "deployment"
          Value: "manual"
      TrafficPolicyId: !GetAtt SESMailManagerTrafficPolicy.TrafficPolicyId
      Type: AUTH

  SESMailConfigurationSet:
    Type: AWS::SES::ConfigurationSet
    Properties:
       Name: ConfigSet1
       DeliveryOptions:
         TlsPolicy: REQUIRE

  SNSEncryptionKey:
    Type: AWS::KMS::Key
    Properties:
      Description: KMS Key for encrypting the SES Event SNS Topic
      KeyPolicy:
        Version: '2012-10-17'
        Id: key-default-1
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action: "kms:*"
            Resource: "*"
  
          - Sid: AllowSNSEncryption
            Effect: Allow
            Principal:
              Service: "sns.amazonaws.com"
            Action:
              - kms:GenerateDataKey
              - kms:Decrypt
            Resource: "*"
          
          - Sid: AllowSESToUseKMSKey
            Effect: Allow
            Principal:
              Service: "ses.amazonaws.com"
            Action:
              - kms:GenerateDataKey
              - kms:Decrypt
            Resource: "*"
            Condition:
              StringEquals:
                "aws:SourceAccount": !Ref "AWS::AccountId"
      
      KeyUsage: ENCRYPT_DECRYPT
      Tags:
        - Key: Name
          Value: "Yep-SES-Events-Key"
        - Key: Service
          Value: SNS-SES-Integration

  SESEventsTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: "Yep-SES-Events"
      TopicName: "Yep-SES-Events"
      # Attach the KMS Key for Server-Side Encryption
      KmsMasterKeyId: !GetAtt SNSEncryptionKey.Arn 

  SESEventsTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      Topics:
        - !Ref SESEventsTopic
      PolicyDocument:
        Version: '2012-10-17'
        Id: SESPublishPolicy
        Statement:
          - Sid: AllowSESPublish
            Effect: Allow
            Principal:
              Service: "ses.amazonaws.com"
            Action: "sns:Publish"
            Resource: !Ref SESEventsTopic
            Condition:
              StringEquals:
                "aws:SourceAccount": !Ref "AWS::AccountId"
              
  SESEventsEventDestination:
    Type: AWS::SES::ConfigurationSetEventDestination
    Properties:
      ConfigurationSetName: !Ref SESMailConfigurationSet
      EventDestination:
        Enabled: true
        MatchingEventTypes:
          - SEND
          - REJECT
          - BOUNCE
          - COMPLAINT
          - DELIVERY
          - OPEN
          - CLICK
          - RENDERING_FAILURE
          - DELIVERY_DELAY
          - SUBSCRIPTION
        SnsDestination:
          TopicARN: !Ref SESEventsTopic

  SESMailReceiptRuleSet:
     Type: AWS::SES::ReceiptRuleSet
     Properties:
       RuleSetName: default-rule-set

  SESTemplate:
    Type: AWS::SES::Template
    Properties:
      Template:
        TemplateName: "TestSESTemplate"
        SubjectPart: "TEST - Please ignore"
        TextPart: "Hello Test Subject,\n\nPlease be aware this is a test email only."
        HtmlPart: "<h1>Hello Test Subject</h1><p>Please be aware this is a test email only</p>"